<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0"/>
  <title>Hassio Google Drive Backup</title>

  <!-- CSS  -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="css/materialize.css" type="text/css" rel="stylesheet" media="screen,projection"/>
  <link href="css/style.css" type="text/css" rel="stylesheet" media="screen,projection"/>
  <link rel="icon" 
      type="image/png" 
      href="/images/favicon.png">

  <script src="js/jquery.js"></script>
</head>
<body>
   <nav class="grey darken-3" role="navigation">
    <div class="nav-wrapper container">
      <a id="logo-container" href="/" class="brand-logo"><img src="/images/logo.png" width=40 height=40/>Hassio Google Drive Backup
      </a>
    </div>
  </nav>
  <div class="section no-pad-bot" id="index-banner">
    <div class="container">
      <br><br>
      <h1 class="header center orange-text">Get Started</h1>
      <div class="row center">
        <h5 class="header col s12 light">To begin, this add-on will need access to your Google Drive&trade;.  On your first backup it will create a new folder at the root of your <a href="https://drive.google.com/drive/my-drive">My Drive</a> where future backups will be stored.  Once its created, you can move the folder wherever you want</h5>
      </div>
      <div>
         
      </div>
      <div class="row center">
        <div class="col s5">
          <h4 class="orange-text text-darken-4">Option 1</h4>
            Login through an <a href="http://philosophyofpen.com/hassiodrivebackup">external domain</a> configured to authenticate this add-on.  You'll be routed back to this page after you're finished and your credentials only get stored locally.
        </br/>
          <a href="http://materializecss.com/getting-started.html" id="authenticate-button" class="btn-large waves-effect waves-light orange">Authenticate with Google Drive</a>
        </div>
        <div class="col s1">
          or...
        </div>
        <div class="col s5">
          
            <h4 class="orange-text text-darken-4">Option 2</h4>
            Follow the <a target="_blank" href="https://github.com/sabeechen/hassio-google-drive-backup/blob/master/LOCAL_AUTH.md">instructions here</a> to get your own client ID and client secret from Google.  This is a much more complicated and time consuming approach, but doesn't require you to authenticate yourself with an external domain.
            <div class="row">
              <form class="col s10" action="/manualauth" method="get">
                <div class="row">
                  <div class="input-field col s12">
                    <i class="material-icons prefix">vpn_key</i>
                    <input id="client_id" name="client_id" type="text" class="validate"/>
                    <label for="client_id">Client ID</label>
                  </div>
                  </div>
                  <div class="row">
                    <div class="input-field col s12">
                      <i class="material-icons prefix">vpn_key</i>
                      <input id="client_secret" name="client_secret" type="text" class="validate"/>
                      <label for="client_secret">Client Secret</label>
                    </div>
                  </div>
                  <div class=row>
                      <div class="input-field col s12">
                        <a target="_blank" class="btn-large waves-effect waves-light orange disabled" id="secret_button" onclick="getAuthUrl()">Connect</a>
                      </div>
                  </div>
              </form>
              <div class=row>
                  <div class="col s12" id="help_text" style="display: none">
                    <p>
                      Click "Connect" once you have a client ID and client secret.  This will redirect you to Google's authentications servers where you you will be given an authentication code that you can enter below to finish authorization.
                    </p>
                  </div>
              </div>
              <div class="row" style="display: none" id="code_form">
                <div class="col s12">
                  <form class="col s10" action="/manualauth" method="get" >
                    <div class="row">
                      <div class="input-field col s12">
                        <i class="material-icons prefix">vpn_key</i>
                        <input id="code" name="code" type="text" class="validate disabled">
                        <label for="code">Code from Google</label>
                      </div>
                    </div>
                    <div class=row>
                        <div class="col s12">
                          <a target="_blank" class="btn-large waves-effect waves-light orange disabled" id="manualauthbutton" onClick="submitCode()">Authorize</a>
                        </div>
                    </div>
                  </form>
                </div>
              </div>
            </div>
        </div>
      </div>
      <div class="row center">
        <h6 class="header col s12 light">*Note: this will <i>only</i> have access to the files and folders it creates.  The Add-on can't see any of the other files you've added to Google Drive.</h6>
      </div>
      <br><br>
    </div>
  </div>


  <div class="container">
    <div class="section">

      <div class="row">
      </div>

    </div>
    <br><br>
  </div>

  <footer class="page-footer grey darken-3">
    <div class="container">
      <div class="row">
        <div class="col l3 s12">
          <h5 class="white-text">Connect</h5>
          <ul>
            <li><a class="white-text" href="https://github.com/sabeechen/hassio-google-drive-backup">Project Github</a></li>
            <li><a class="white-text" href="https://github.com/sabeechen/hassio-google-drive-backup/issues">Issue Tracker</a></li>
            <li><a class="white-text" href="https://materializecss.com">Materialize</a></li>
          </ul>
        </div>
        <div class="col l6 s12">
          <h5 class="white-text">Who did this?</h5>
          <p class="grey-text text-lighten-4">I'm an individual who works on projects like this in my spare time.  If you like it and would like to support me, I don't want your money but you can star my projects on <a href="https://github.com/sabeechen">Github</a></p>
        </div>
      </div>
    </div>
  </footer>


  <!--  Scripts-->
  <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
  <script src="js/materialize.js"></script>
  <script src="js/init.js"></script>
  <script type="text/javascript">
    document.getElementById("authenticate-button").href = 
      "https://philosophyofpen.com/login/backup.py?redirectbacktoken=" + encodeURIComponent(location.protocol + "//" + location.hostname + ":" + location.port + "/token");

      function submitCode() {
        var code = $("#code").val();
          if (!code || code.length == 0) {
            M.toast({html: "Please enter the code you got form Google by clicking \"connect\" above"})
          }
          var url = "/manualauth?code=" + code;
          $.get(url, 
          function(data) {
            M.toast({html: "Requesting authorization URL..."})
            if (data.hasOwnProperty("auth_url")) {
              console.log("Redirecting to " + data.auth_url)
              window.location = data.auth_url
            } else if (data.hasOwnProperty("error")) {
              M.toast({html: data.error})
            }
          }, "json")
      }

      function updateHref() {
        var client_id = $("#client_id").val();
        var client_secret = $("#client_secret").val();
          if (client_id && client_id.length > 0 && client_secret && client_secret.length > 0) {
            $("#secret_button").removeClass('disabled');
            $("#help_text").fadeIn(400)
            $("#code_form").fadeIn(400)
          } else {
            $("#secret_button").addClass('disabled');
          }
      }
      $("#client_id").change(updateHref)
      $("#client_secret").change(updateHref)
      $("#client_secret").keyup(updateHref)
      $("#client_id").keyup(updateHref)
      $("#client_secret").mouseup(updateHref)
      $("#client_id").mouseup(updateHref)

      function getAuthUrl() {
        var client_id = $("#client_id").val();
        var client_secret = $("#client_secret").val();
        if (!(client_id && client_id.length > 0 && client_secret && client_secret.length > 0)) {
          M.toast({html: "Please enter a Client Id and Client Secret first"})
        }
        var url = "/manualauth?client_id=" + client_id + "&client_secret=" + client_secret;
        console.log("Requesting auth url from " + url);
        $.get(url, 
          function(data) {
            M.toast({html: "Requesting authorization URL..."})
            if (data.hasOwnProperty("auth_url")) {
              console.log("Opening window to " + data.auth_url)
              window.open(data.auth_url);
              $("#code").removeClass("disabled")
              $("#manualauthbutton").removeClass("disabled")
            } else if (data.hasOwnProperty("error")) {
              M.toast({html: data.error})
              
              $("#code").addClass("disabled")
              $("#manualauthbutton").addClass("disabled")
            }
          }, "json")
      }

  </script>
  </body>
</html>
